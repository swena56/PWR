<?php

namespace App\Http\Controllers;

use Illuminate\Support\Facades\DB;
use Illuminate\Http\Request;
use utilphp\util;
use Carbon\Carbon;
use Datetime;
use Intervention\Httpauth\Httpauth;


class DeliveryController extends Controller
{
    //
    function index(){
	$users = DB::table('deliveries')->where('source', 'Delivery')->get();


	return util::var_dump($users);
    }

    

    function getWorkDates($store_id, $json=false){


	$dates = DB::select(
			"SELECT SUBSTRING_INDEX(order_id, '#', 1) AS date FROM deliveries WHERE store_id = :store_id GROUP BY date",
			['store_id'=> 1953]
		 );

	if( $json ){
		return 	$dates->toJson();
	} else{
		return $dates;
		return util::var_dump($dates);
	}
    }
    function getDrivers($store_id, $json=false){


	$drivers = DB::table('deliveries')
		->select('driver')
		->where('store_id',$store_id)
		->groupBy('driver')
		->get();

	//remove driver ()
	if( $json ){

		return $drivers;
	} else {
		return $drivers->toJson();
	}		
    }

    function get(Request $request, $store_id, $date=null, $driver=null){
	//	return var_dump( $request->headers );

	//if( array_key_exists( 'php-auth-user', $request->headers->all() ) != true || array_key_exists( 'php-auth-pw', $request->headers->all() ) != true ){
	if( array_key_exists( 'php-auth-user', $request->headers->al() ) != true || array_key_exists( 'php-auth-pw', $request->headers->all() ) != true ){
	//	return var_dump( $request->headers->all());
		return "Need to Login";
	} else {

	
		$user = $request->headers->all()['php-auth-user'];
		$password = $request->headers->all()['php-auth-pw'];
		return "$user $password";
		//check if this is a valid user password combination
		if( $user != "user" || $password != "password" ){
			return "Invalid Creds";
		}		
	}


	$now = Carbon::now();	
	$now->setTimezone('America/Chicago');
	//return util::var_dump($now);
	//return util::var_dump($this->getDrivers("1953"));
	//return util::var_dump($this->getWorkDates("1953"));
	$store_id = util::htmlentities($store_id, TRUE);

	if( $date != null ){
		if( $this->validateDate($date) == false ){
			return "invalid_date";
		}
		$date = util::htmlentities($date, TRUE);
	}

	
	$driver = util::htmlentities($driver, TRUE);

	$order = null;
	if( $date == null ){	
	$orders = DB::table('deliveries')
		//->selectRaw("*,TRIM(LEADING '$' FROM price) AS price")
		->selectRaw("order_id,address,timestamp, source, service, status, description,phone,TRIM(LEADING '$' FROM price) AS price")
		 ->whereRaw("store_id = ? AND source = 'Delivery'", [$store_id])
                ->get();

	} else {

	//return $date;
	$orders = DB::table('deliveries')
		->whereRaw("store_id = ?",[$store_id])
		->whereRaw("source = ?",['Delivery'])
		->whereRaw("timestamp >= ?",[$date])
		->OrderByRaw('order_id ASC')
                ->get();
	}
	/*	
	$o = [];
	$i = 1;
	foreach( $orders as $order ) {
		$order->id = $i;
		array_push($o,$order);
		$i++;
	}
	*/
	return json_encode($orders);
	return var_dump($orders);
	return $orders->toJson();
	//return "$store_id\n$date\n$driver\n" . util::var_dump($orders);
    }

    function validateDate($date, $format = 'Y-m-d')
    {
    	$d = DateTime::createFromFormat($format, $date);
	return $d && $d->format($format) == $date;
    }
}
